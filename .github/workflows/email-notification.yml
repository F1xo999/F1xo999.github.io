name: Email Notification

on:
  push:
    branches:
      - main

jobs:
  sendEmail:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install dependencies
        run: npm install
        
      - name: Install jq
        run: |
         # Download jq binary
          wget https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe -O jq.exe
         # Move jq binary to a directory in the PATH
           move jq.exe /usr/local/bin/


      - name: Capture form data
        id: capture-form-data
        run: |
         # Extract form field values
          name=$(jq -n --arg value "$(<index.html)" '$value | fromjson | .name')
          email=$(jq -n --arg value "$(<index.html)" '$value | fromjson | .email')
          message=$(jq -n --arg value "$(<index.html)" '$value | fromjson | .message')

          # Set form data as environment variable
           echo "FORM_DATA={\"name\":\"$name\",\"email\":\"$email\",\"message\":\"$message\"}" >> $GITHUB_ENV



      - name: Send email
        env:
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          # Import the required libraries
          const sgMail = require('@sendgrid/mail');

          # Set up the SendGrid API key
          sgMail.setApiKey(process.env.SENDGRID_API_KEY);

          # Get form data from the previous step
          const formData = process.env.FORM_DATA;

          # Construct the email message using the form data
          const message = {
            to: 'spyfilip@gmail.com',  // Replace with your email address
            from: 'kontaktstranka@gmail.com',   // Replace with the sender email address
            subject: 'Form Submission',
            text: `A form submission was received:\n\n${formData}`
          };

          # Send the email
          sgMail.send(message)
            .then(() => {
              console.log('Email sent successfully');
            })
            .catch((error) => {
              console.error('Error sending email:', error);
            });



